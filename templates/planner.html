{% extends "base.html" %}

{% block title %}–í–∞—à –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫{% endblock %}

{% block scripts %}
<script>
    // –ü–µ—Ä–µ–∫–æ–Ω—É—î–º–æ—Å—å, —â–æ –æ–±'—î–∫—Ç Telegram WebApp –¥–æ—Å—Ç—É–ø–Ω–∏–π
    if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;
        tg.ready(); // –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ Telegram, —â–æ –¥–æ–¥–∞—Ç–æ–∫ –≥–æ—Ç–æ–≤–∏–π

        const shareButton = document.getElementById('shareTasksButton');

        if (shareButton) {
            shareButton.addEventListener('click', function() {
                // 1. –ó–±–∏—Ä–∞—î–º–æ –∑–∞–≤–¥–∞–Ω–Ω—è –∑—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ (–∞–±–æ –º–æ–∂–Ω–∞ –∑—Ä–æ–±–∏—Ç–∏ API –∑–∞–ø–∏—Ç)
                // –ü—Ä–æ—Å—Ç—ñ—à–∏–π –≤–∞—Ä—ñ–∞–Ω—Ç: –∑–±–∏—Ä–∞—î–º–æ –ø—Ä—è–º–æ –∑—ñ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏ HTML
                let tasksByCategory = {};
                document.querySelectorAll('.category-section').forEach(section => {
                    const categoryTitleElement = section.querySelector('.category-title');
                    // –í–∏—Ç—è–≥—É—î–º–æ –∫–ª—é—á –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑ –Ω–∞–∑–≤–∏ (–ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–¥–∞—Ç–∏ data-key –≤ HTML)
                    // –ê–ë–û –ø—Ä–æ—Å—Ç—ñ—à–µ - –±–µ—Ä–µ–º–æ —Ç–µ–∫—Å—Ç–æ–≤—É –Ω–∞–∑–≤—É —è–∫ —î
                    const categoryName = categoryTitleElement ? categoryTitleElement.textContent.trim() : '–ù–µ–≤—ñ–¥–æ–º–∞ –ö–∞—Ç–µ–≥–æ—Ä—ñ—è';
                    tasksByCategory[categoryName] = [];

                    section.querySelectorAll('.task-item').forEach(item => {
                        const content = item.querySelector('.task-content') ? item.querySelector('.task-content').textContent.trim() : '';
                        const isCompleted = item.classList.contains('completed');
                        tasksByCategory[categoryName].push({ content: content, completed: isCompleted });
                    });
                });

                // 2. –§–æ—Ä–º–∞—Ç—É—î–º–æ —Ç–µ–∫—Å—Ç –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
                let exportTextLines = ["üìã –í–∞—à —Å–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å:\n"];
                for (const categoryName in tasksByCategory) {
                    if (tasksByCategory[categoryName].length > 0) {
                        exportTextLines.push(`\n--- ${categoryName} ---`);
                        tasksByCategory[categoryName].forEach(task => {
                            const statusEmoji = task.completed ? "‚úîÔ∏è" : "‚≠ï";
                            exportTextLines.push(`${statusEmoji} ${task.content}`);
                        });
                    }
                }
                const exportText = exportTextLines.join("\n");

                // 3. –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –¥–æ–≤–∂–∏–Ω–∏ (Telegram WebApp.sendData –º–∞—î –ª—ñ–º—ñ—Ç ~4096 –±–∞–π—Ç)
                if (new TextEncoder().encode(exportText).length > 4000) {
                   tg.showAlert("–í–∏–±–∞—á—Ç–µ, —Å–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å –∑–∞–Ω–∞–¥—Ç–æ –¥–æ–≤–≥–∏–π –¥–ª—è –ø—Ä—è–º–æ—ó –≤—ñ–¥–ø—Ä–∞–≤–∫–∏. –°–ø—Ä–æ–±—É–π—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –¥–µ—è–∫—ñ –≤–∏–∫–æ–Ω–∞–Ω—ñ –∑–∞–≤–¥–∞–Ω–Ω—è.");
                   return;
                }

                // 4. –ù–∞–¥—Å–∏–ª–∞—î–º–æ –¥–∞–Ω—ñ –±–æ—Ç—É
                if (exportText.length > "üìã –í–∞—à —Å–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å:\n".length) { // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ —î —â–æ –Ω–∞–¥—Å–∏–ª–∞—Ç–∏
                    tg.sendData(exportText);
                    // –ú–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è, –∞–ª–µ sendData –∑–∞–∑–≤–∏—á–∞–π –∑–∞–∫—Ä–∏–≤–∞—î Web App
                    // tg.showAlert('–°–ø–∏—Å–æ–∫ –∑–∞–≤–¥–∞–Ω—å –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ –±–æ—Ç—É. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —á–∞—Ç —ñ–∑ –Ω–∏–º.');
                } else {
                    tg.showAlert('–£ –≤–∞—Å –Ω–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å –¥–ª—è –ø–æ—à–∏—Ä–µ–Ω–Ω—è.');
                }
            });
        } else {
             console.error("–ö–Ω–æ–ø–∫—É 'shareTasksButton' –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!");
        }

    } else {
        console.error("Telegram WebApp script –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ –∞–±–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π!");
        // –ú–æ–∂–Ω–∞ –ø–æ–∫–∞–∑–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É, —â–æ —Ñ—É–Ω–∫—Ü—ñ—è –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ–∑–∞ Telegram
        const shareButton = document.getElementById('shareTasksButton');
        if(shareButton) {
            shareButton.disabled = true;
            shareButton.textContent = "–§—É–Ω–∫—Ü—ñ—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç—ñ–ª—å–∫–∏ –≤ Telegram";
        }
    }
</script>
{% endblock %}

{% block content %}
<h2>üìÖ –ú—ñ–π –ü–ª–∞–Ω—É–≤–∞–ª—å–Ω–∏–∫ –ó–∞–≤–¥–∞–Ω—å</h2>
<hr>

<div class="card mb-4">
    <div class="card-header">
        <h4>üìù –î–æ–¥–∞—Ç–∏ –Ω–æ–≤–µ –∑–∞–≤–¥–∞–Ω–Ω—è</h4>
    </div>
    <div class="card-body">
        <form action="{{ url_for('add_task') }}" method="post" class="row g-3 align-items-center">
            <div class="col-md-6">
                <label for="content" class="visually-hidden">–¢–µ–∫—Å—Ç –∑–∞–≤–¥–∞–Ω–Ω—è</label>
                <input type="text" class="form-control" id="content" name="content" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –≤–∞—à–µ –∑–∞–≤–¥–∞–Ω–Ω—è —Ç—É—Ç..." required>
            </div>
            <div class="col-md-4">
                 <label for="category" class="visually-hidden">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è</label>
                 <select name="category" id="category" class="form-select">
                     {% for cat_key, cat_name in categories.items() %}
                     <option value="{{ cat_key }}" {% if cat_key == 'general' %}selected{% endif %}>{{ cat_name }}</option>
                     {% endfor %}
                 </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">–î–æ–¥–∞—Ç–∏</button>
            </div>
        </form>
    </div>
    
    <div class="mt-4 mb-4 text-center">
        <button id="shareTasksButton" class="btn btn-info">üì≤ –ü–æ–¥—ñ–ª–∏—Ç–∏—Å—è —Å–ø–∏—Å–∫–æ–º –≤ Telegram</button>
    </div>
    
</div>


<div class="row">
  {% for category_key, category_name in categories.items() %}
    <div class="col-lg-6 mb-4"> <div class="category-section">
            <h3 class="category-title">{{ category_name }}</h3>
            {% set tasks = tasks_by_category[category_key] %}
            {% if tasks %}
                <ul class="list-unstyled">
                    {% for task in tasks %}
                    <li class="task-item {% if task.is_completed %}completed{% endif %}">
                        <span class="task-content">{{ task.content }}</span>
                        <div class="task-actions">
                            <form action="{{ url_for('toggle_task', task_id=task.id) }}" method="post">
                                <button type="submit" class="btn btn-sm {% if task.is_completed %}btn-secondary{% else %}btn-success{% endif %}">
                                    {% if task.is_completed %}‚Ü©Ô∏è{% else %}‚úîÔ∏è{% endif %}
                                </button>
                            </form>
                            <a href="{{ url_for('edit_task', task_id=task.id) }}" class="btn btn-sm btn-warning">‚úèÔ∏è</a>
                            <form action="{{ url_for('delete_task', task_id=task.id) }}" method="post" onsubmit="return confirm('–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —Ü–µ –∑–∞–≤–¥–∞–Ω–Ω—è?');">
                                <button type="submit" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                            </form>
                        </div>
                    </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-muted">–ù–µ–º–∞—î –∑–∞–≤–¥–∞–Ω—å —É —Ü—ñ–π –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.</p>
            {% endif %}
        </div>
    </div>
  {% endfor %}
</div>

{% endblock %}
